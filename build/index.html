<html lang="en">
<head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/ansi_up@4.0.4/ansi_up.min.js" type="text/javascript"></script>
    <title>Hazelcast Cloud Shell</title>
</head>
<body>
<pre id="console">Welcome to Hazelcast Cloud Shell!<br></pre>
<div id="loading" style="display: none"></div>
<div id="prompt">
    <div id="prompt-start"><span style="color:greenyellow">yunus@hzcloud</span><span>:</span><span
                style="color:dodgerblue">~</span><span>$</span></div><span id="test"></span>
    <input id="input" autofocus>
</div>
<script src="wasm_exec.js"></script>
<script>
    let bashHistoryIndex = 0;
    let bashHistory = [""];
    consoleObj = document.getElementById("console")
    loadingObj = document.getElementById("loading")
    promptStart = document.getElementById("prompt-start")
    promptObj = document.getElementById("prompt")
    inputObj = document.getElementById("input")

    fetch('main.wasm').then(response => response.arrayBuffer()).then(function (bin) {
        inputObj.addEventListener('keydown', function (event) {
            if (event.code === "ArrowUp") {
                this.value = bashHistory[bashHistoryIndex]
                if (bashHistoryIndex !== 0) {
                    bashHistoryIndex--;
                }
                return;
            }
            if (event.code === "ArrowDown") {
                this.value = bashHistory[bashHistoryIndex]
                if (bashHistoryIndex !== bashHistory.length - 1) {
                    bashHistoryIndex++;
                }
                return;
            }
            if (event.code !== "Enter"){
                return;
            }

            const go = new Go();
            go.argv = this.value.split(' ');
            go.env = {
                "HZ_CLOUD_API_KEY": "",
                "HZ_CLOUD_API_SECRET": "",
            }

            consoleObj.append(promptStart.cloneNode(true))
            consoleObj.append(" " + this.value + "\n")
            bashHistory.push(this.value)
            bashHistoryIndex = bashHistory.length - 1

            this.value = '';
            loadingObj.style.display = "block"
            promptObj.style.display = "none"

            const decoder = new TextDecoder("utf-8");
            global.fs.writeSync = function (fd, buf) {
                consoleObj.innerHTML += new AnsiUp().ansi_to_html(decoder.decode(buf))
                return buf.length;
            };

            WebAssembly.instantiate(bin, go.importObject).then((result) => {
                go.run(result.instance).then(x => {
                    promptObj.style.display = "block"
                    loadingObj.style.display = "none"
                    consoleObj.scrollTop = consoleObj.scrollHeight;
                    inputObj.focus()
                });
            });
        });
        document.addEventListener("click", function () {
            inputObj.focus()
        })
    });

    var i = 0;
    setInterval(function() {
        const spinner = "⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏"
        if (loadingObj.style.display !== "none") {
            loadingObj.innerHTML = spinner[i] + " Loading";
            i = (i + 1) % spinner.length;
        }
    }, 100);
</script>

<style>
    #prompt-start {
        display: inline-block;
    }

    input {
        width: 80%;
        border: none;
        outline: none !important;
        color: white;
        background: transparent;
        display: inline-block;
        font-family: monospace;
        font-size: 15px;
        line-height: 20px;
    }

    body {
        color: white;
        background: black;
        margin: 15px;
        font-family: monospace;
        font-size: 15px;
        line-height: 20px;
    }

    pre {
        margin: 0;
        font-family: monospace;
        font-size: 15px;
        line-height: 20px;
    }
</style>
</body>
</html>